# =========================================================================
# REQUIRED SECRETS FOR THIS PIPELINE
# You must configure these 6 secrets in your GitHub Repository under:
# Settings -> Secrets and variables -> Actions -> "New repository secret"
#
# 1. AWS_ACCESS_KEY_ID:     Your AWS IAM User Access Key
# 2. AWS_SECRET_ACCESS_KEY: Your AWS IAM User Secret Key
# 3. AWS_REGION:            AWS Region (e.g., us-east-1)
# 4. EC2_HOST:              Public IP or DNS of your EC2 instance
# 5. EC2_USERNAME:          SSH user for your instance (e.g., ec2-user or ubuntu)
# 6. EC2_SSH_KEY:           The full contents of your .pem file
# =========================================================================


name: Deploy m1 and m2 to EC2

on:
  workflow_dispatch:
  push:
    paths:
      - 'microservice-1/**'
      - 'microservice-2/**'
    branches:
      - main

jobs:
  deploy-to-ec2:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    # --- Build and Push m1 ---
    - name: Build, tag, and push m1 image to ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: microservice-1
        IMAGE_TAG: latest
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG ./microservice-1
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

    # --- Build and Push m2 ---
    - name: Build, tag, and push m2 image to ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: microservice-2
        IMAGE_TAG: latest
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG ./microservice-2
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

    # --- Deploy to EC2 via SSH ---
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        AWS_REGION: ${{ secrets.AWS_REGION }}
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        envs: ECR_REGISTRY,AWS_REGION
        script: |
          # Install AWS CLI if it is not installed
          if ! command -v aws &> /dev/null; then
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
              
              # Ensure unzip is installed
              if ! command -v unzip &> /dev/null; then
                  sudo apt-get update && sudo apt-get install -y unzip || sudo yum install -y unzip || true
              fi
              
              unzip -q awscliv2.zip
              sudo ./aws/install
              rm -rf aws awscliv2.zip
          fi
          
          # Temporarily set AWS credentials using secrets passed to the EC2 action
          export AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          export AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          export AWS_DEFAULT_REGION=$AWS_REGION
          
          # Login to ECR on the EC2 instance
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
          
          # Pull latest images
          docker pull $ECR_REGISTRY/microservice-1:latest
          docker pull $ECR_REGISTRY/microservice-2:latest
          
          # Ensure custom network exists for container-to-container communication
          docker network create microservices-net || true
          
          # Restart m1
          docker stop microservice-1 || true
          docker rm microservice-1 || true
          docker run -d --name microservice-1 --network microservices-net -p 8081:8081 $ECR_REGISTRY/microservice-1:latest
          
          # Restart m2
          docker stop microservice-2 || true
          docker rm microservice-2 || true
          docker run -d --name microservice-2 --network microservices-net -p 8082:8082 $ECR_REGISTRY/microservice-2:latest
